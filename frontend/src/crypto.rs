use ::kem::Decapsulate;
use ::kem::Encapsulate;
use aes_gcm_siv::aead::OsRng;
use argon2::{Algorithm, Argon2, Version};
use ml_kem::*;
use ml_kem::{KemCore, B32};
use rand::Rng;
use sha3::Digest;

use aes_gcm_siv::{
    aead::{Aead, KeyInit},
    Aes256GcmSiv, Nonce,
};

// re-export for convenience
pub use ml_kem::MlKem1024;

/// Generate key material from a password using the username as salt
fn key_derivation(password: &str, username: &str) -> [u8; 64] {
    let mut output_key_material = [0u8; 64];
    let salt = format!("cipherly{username}");

    // https://www.rfc-editor.org/rfc/rfc9106.html#name-parameter-choice
    // recommendation 2: 3 iterations, 4 lanes,64MiB RAM
    let mut params_builder = argon2::ParamsBuilder::DEFAULT;
    let params = params_builder
        .t_cost(3)
        .p_cost(4)
        .m_cost(65536)
        .build()
        .unwrap();
    Argon2::new(Algorithm::Argon2id, Version::V0x13, params)
        .hash_password_into(
            password.as_bytes(),
            salt.as_bytes(),
            &mut output_key_material,
        )
        .unwrap();

    output_key_material
}

/// Generate a decapsulation keypair
pub fn generate_keys<K: KemCore>(
    password: &str,
    username: &str,
) -> (K::DecapsulationKey, K::EncapsulationKey) {
    let key_input = key_derivation(password, username);

    let d = B32::from_slice(&key_input[..32]);
    let z = B32::from_slice(&key_input[32..]);

    let (dk, ek) = K::generate_deterministic(d, z);

    (dk, ek)
}

fn ek_from_bytes<K: KemCore>(input: &[u8]) -> K::EncapsulationKey {
    let ek = Encoded::<K::EncapsulationKey>::from_slice(input);
    K::EncapsulationKey::from_bytes(ek)
}

fn ek_shared_secret<K: KemCore>(ek: &K::EncapsulationKey) -> (Vec<u8>, Vec<u8>) {
    let mut rng = rand::thread_rng();

    let (c, k) = ek.encapsulate(&mut rng).unwrap();

    (c.to_vec(), k.to_vec())
}

pub struct EncryptionResult {
    pub ciphertext: Vec<u8>,
    pub encapsulated_sym_key: Vec<u8>,
    pub nonce: Vec<u8>,
}
/// encrypt a plaintext and encapsulate the symmetric key using the provided encapsulation key
pub fn encrypt(encapsulation_key: &[u8], plaintext: &str) -> anyhow::Result<EncryptionResult> {
    let ek = ek_from_bytes::<MlKem1024>(encapsulation_key);

    let (encapsulated_sym_key, sym_key) = ek_shared_secret::<MlKem1024>(&ek);

    let nonce = OsRng.gen::<[u8; 12]>();
    let ciphertext = aes_enc(plaintext.as_bytes(), &sym_key, &nonce)?;

    Ok(EncryptionResult {
        ciphertext,
        encapsulated_sym_key,
        nonce: nonce.to_vec(),
    })
}

/// deecrypt performs the whole decryption process, key generation, decapsulation and decryption
pub fn decrypt<K: KemCore>(
    password: &str,
    username: &str,
    ciphertext: &[u8],
    encapsulated_sym_key: &[u8],
    nonce: &[u8],
) -> anyhow::Result<String> {
    let encapsulated_secret = Ciphertext::<K>::from_slice(encapsulated_sym_key);

    let (dk, _) = generate_keys::<K>(password, username);

    let sym_key = dk
        .decapsulate(encapsulated_secret)
        .map_err(|e| anyhow::anyhow!("Failed to decapsulate symetric key: {:?}", e))?;

    let plaintext = aes_dec(ciphertext, &sym_key, nonce)
        .map_err(|e| anyhow::anyhow!("Failed to decrypt ciphertext: {:?}", e))?;

    String::from_utf8(plaintext).map_err(|e| anyhow::anyhow!(e))
}

fn aes_enc(plaintext: &[u8], key: &[u8], nonce: &[u8]) -> anyhow::Result<Vec<u8>> {
    let cipher = Aes256GcmSiv::new_from_slice(key)?;
    let nonce = Nonce::from_slice(nonce);
    let ciphertext = cipher
        .encrypt(nonce, plaintext.as_ref())
        .map_err(|e| anyhow::anyhow!("Failed to aes encrypt: {:?}", e))?;

    Ok(ciphertext)
}

fn aes_dec(ciphertext: &[u8], key: &[u8], nonce: &[u8]) -> anyhow::Result<Vec<u8>> {
    let cipher = Aes256GcmSiv::new_from_slice(key)?;
    let nonce = Nonce::from_slice(nonce);
    let ciphertext = cipher
        .decrypt(nonce, ciphertext.as_ref())
        .map_err(|e| anyhow::anyhow!("Failed to aes decrypt: {:?}", e))?;

    Ok(ciphertext)
}

/// Calculate the fingerprint of an encapsulation key
pub fn encapsulation_key_fingerprint(encapsulation_key: &[u8]) -> String {
    let mut hasher = sha3::Sha3_256::new();
    hasher.update(encapsulation_key);
    format!("{:X}", hasher.finalize())
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn encrypt_decrypt_roundtrip_test() {
        let password = "somepassword";
        let username = "username";
        let plaintext = "plaintext";

        let (_, encapsulaton_key) = generate_keys::<MlKem1024>(password, username);

        let EncryptionResult {
            ciphertext,
            encapsulated_sym_key,
            nonce,
        } = encrypt(&encapsulaton_key.as_bytes(), plaintext).unwrap();

        let decrypted = decrypt::<MlKem1024>(
            password,
            username,
            &ciphertext,
            &encapsulated_sym_key,
            &nonce,
        )
        .unwrap();

        assert_eq!(decrypted, plaintext);
    }

    #[test]
    fn aes_plus_kyber() {
        let mut rng = rand::thread_rng();

        let password = "qqq";
        let username = "username";

        let plaintext = b"some plaintext message";

        let (_dk, ek) = generate_keys::<MlKem1024>(password, username);

        let (_, k_send) = ek.encapsulate(&mut rng).unwrap();

        let nonce = b"unique nonce";
        let ciphertext = aes_enc(plaintext, &k_send, nonce).unwrap();

        let dec_plaintext = aes_dec(&ciphertext, &k_send, nonce).unwrap();

        assert_eq!(dec_plaintext, plaintext);
    }

    #[test]
    fn kyber_roundtrip_test() {
        let mut rng = rand::thread_rng();

        let password = "qqq";
        let username = "username";

        let (_, ek) = generate_keys::<MlKem1024>(password, username);
        let (dk, _) = generate_keys::<MlKem1024>(password, username);

        let (ct, k_send) = ek.encapsulate(&mut rng).unwrap();
        let k_recv = dk.decapsulate(&ct).unwrap();

        println!("{:?}", k_send);
        println!("{:?}", k_recv);
        assert_eq!(k_send, k_recv);
    }

    #[test]
    fn test_decrypt() {
        let mut rng = rand::thread_rng();

        let password = "qqq";
        let username = "username";

        let (_, ek) = generate_keys::<MlKem1024>(password, username);
        let (ct, k_send) = ek.encapsulate(&mut rng).unwrap();

        let nonce = b"unique nonce";
        let aes_cipher = aes_enc(b"plaintext", &k_send, nonce).unwrap();

        let k_recv = decrypt::<MlKem1024>(password, username, &aes_cipher, &ct, nonce).unwrap();

        assert_eq!(k_recv, "plaintext")
    }

    #[test]
    /// This test detects breaking changes in the key derivation function
    fn key_derivation_test() {
        let password = "somepassword";
        let username = "someusername";
        let key = key_derivation(password, username);

        let expected = [
            104, 143, 235, 85, 194, 150, 234, 118, 119, 198, 229, 81, 32, 139, 81, 195, 223, 182,
            67, 195, 178, 197, 204, 63, 29, 30, 225, 174, 246, 203, 145, 116, 190, 26, 9, 156, 205,
            158, 74, 145, 185, 247, 91, 211, 32, 114, 46, 235, 50, 107, 117, 101, 134, 254, 21, 5,
            125, 122, 211, 124, 116, 114, 240, 111,
        ];
        assert_eq!(key, expected);
    }

    #[test]
    fn kyber_keygen_compatibility() {
        let (dk, ek) = generate_keys::<MlKem1024>("somepassword", "someusername");

        assert_eq!(
            dk.as_bytes().as_slice(),
            [
                148, 152, 49, 119, 194, 43, 178, 41, 86, 224, 169, 5, 233, 140, 126, 229, 32, 135,
                106, 44, 179, 139, 115, 201, 235, 51, 82, 102, 236, 76, 111, 73, 77, 139, 73, 182,
                190, 195, 196, 128, 102, 3, 238, 69, 54, 221, 123, 34, 20, 218, 92, 212, 112, 156,
                135, 108, 16, 51, 58, 118, 198, 233, 119, 41, 139, 195, 86, 150, 9, 67, 104, 145,
                142, 218, 5, 172, 135, 194, 143, 2, 207, 154, 67, 72, 151, 38, 46, 72, 120, 64, 77,
                64, 22, 245, 201, 122, 97, 156, 47, 156, 149, 177, 63, 25, 31, 1, 98, 178, 77, 224,
                174, 253, 219, 175, 66, 220, 150, 199, 2, 53, 148, 0, 81, 133, 7, 19, 241, 42, 81,
                76, 252, 101, 242, 132, 195, 103, 247, 43, 230, 24, 97, 151, 44, 200, 82, 106, 89,
                34, 122, 150, 57, 10, 11, 237, 194, 50, 244, 136, 200, 170, 137, 185, 29, 27, 110,
                123, 106, 77, 38, 181, 32, 6, 136, 177, 155, 34, 176, 253, 120, 42, 208, 192, 122,
                162, 137, 109, 60, 228, 132, 100, 119, 110, 175, 146, 89, 1, 170, 113, 147, 155,
                172, 106, 24, 143, 175, 0, 32, 50, 69, 38, 194, 9, 5, 62, 140, 171, 120, 20, 99,
                251, 81, 137, 9, 148, 60, 241, 18, 144, 138, 44, 140, 87, 152, 76, 217, 135, 127,
                181, 129, 39, 146, 3, 75, 166, 146, 75, 15, 225, 56, 108, 193, 144, 81, 91, 17,
                167, 219, 38, 89, 92, 202, 175, 83, 183, 223, 187, 143, 144, 176, 159, 56, 26, 69,
                139, 214, 207, 69, 34, 195, 0, 185, 114, 23, 60, 186, 150, 72, 199, 215, 18, 4,
                134, 216, 172, 226, 10, 50, 72, 122, 22, 189, 105, 178, 54, 146, 181, 15, 148, 47,
                158, 80, 136, 126, 242, 114, 183, 100, 188, 70, 121, 4, 179, 220, 36, 230, 80, 188,
                135, 87, 58, 46, 66, 56, 160, 183, 193, 3, 186, 71, 1, 215, 73, 198, 215, 26, 249,
                51, 151, 182, 42, 159, 27, 235, 130, 64, 49, 192, 86, 113, 167, 142, 128, 166, 79,
                227, 191, 228, 106, 95, 83, 122, 53, 17, 247, 166, 17, 137, 101, 159, 5, 194, 177,
                163, 207, 58, 51, 117, 27, 147, 154, 33, 80, 44, 76, 180, 125, 171, 69, 116, 194,
                232, 59, 221, 203, 94, 110, 178, 82, 228, 146, 98, 195, 124, 86, 230, 151, 147,
                186, 64, 34, 227, 89, 190, 159, 156, 130, 133, 183, 68, 93, 70, 49, 223, 225, 99,
                142, 67, 113, 203, 136, 13, 79, 44, 184, 240, 208, 192, 119, 2, 187, 255, 233, 77,
                154, 244, 190, 243, 54, 142, 11, 123, 183, 224, 168, 115, 184, 178, 179, 182, 52,
                79, 65, 183, 7, 143, 162, 205, 104, 233, 55, 24, 176, 176, 23, 51, 79, 111, 160,
                180, 11, 83, 39, 124, 197, 83, 33, 131, 70, 25, 188, 129, 127, 6, 16, 63, 67, 17,
                40, 9, 90, 152, 136, 31, 243, 226, 132, 21, 32, 193, 135, 217, 85, 126, 187, 32,
                88, 92, 15, 114, 42, 178, 208, 72, 114, 151, 176, 156, 27, 199, 94, 38, 44, 97,
                195, 234, 81, 61, 50, 45, 94, 17, 203, 173, 247, 110, 82, 138, 23, 45, 144, 61,
                140, 98, 200, 51, 162, 203, 168, 145, 163, 11, 144, 18, 213, 233, 162, 166, 68,
                145, 31, 229, 128, 73, 76, 206, 151, 140, 72, 165, 65, 114, 150, 11, 203, 142, 68,
                49, 96, 19, 168, 173, 92, 66, 32, 38, 84, 186, 146, 189, 223, 57, 88, 64, 196, 176,
                198, 39, 124, 131, 116, 28, 238, 37, 103, 98, 9, 26, 170, 233, 61, 187, 116, 158,
                143, 231, 167, 89, 240, 0, 122, 120, 119, 11, 80, 195, 5, 210, 29, 124, 27, 103,
                212, 69, 131, 171, 50, 160, 170, 115, 95, 221, 212, 4, 75, 128, 80, 126, 155, 11,
                207, 250, 153, 145, 169, 172, 46, 216, 15, 161, 136, 96, 79, 55, 65, 82, 32, 154,
                5, 18, 144, 161, 74, 115, 250, 216, 110, 203, 130, 180, 148, 25, 111, 8, 225, 41,
                129, 218, 145, 55, 147, 126, 30, 10, 201, 88, 85, 13, 136, 249, 174, 62, 81, 43,
                217, 81, 170, 254, 138, 14, 145, 119, 40, 19, 7, 188, 47, 89, 105, 199, 96, 142,
                197, 180, 177, 209, 192, 3, 92, 117, 78, 47, 23, 145, 60, 8, 77, 189, 219, 48, 50,
                56, 1, 130, 6, 93, 38, 1, 173, 55, 113, 39, 173, 167, 137, 249, 87, 165, 239, 76,
                157, 89, 18, 183, 224, 182, 135, 130, 27, 81, 27, 136, 23, 8, 151, 85, 145, 67, 90,
                139, 132, 188, 155, 134, 150, 220, 217, 101, 199, 140, 149, 123, 194, 81, 74, 1,
                50, 38, 212, 175, 220, 88, 141, 160, 195, 87, 26, 232, 206, 5, 5, 10, 0, 226, 8,
                61, 28, 118, 32, 179, 94, 148, 90, 41, 44, 49, 131, 122, 210, 199, 36, 203, 94,
                205, 201, 116, 66, 24, 31, 175, 168, 132, 148, 228, 84, 243, 16, 75, 244, 231, 121,
                174, 7, 43, 148, 96, 142, 100, 37, 113, 216, 87, 146, 233, 9, 3, 13, 183, 126, 62,
                107, 39, 115, 19, 162, 224, 65, 133, 113, 236, 185, 204, 91, 203, 222, 167, 91,
                141, 167, 62, 52, 107, 67, 182, 59, 84, 194, 108, 38, 172, 76, 19, 190, 41, 155,
                32, 133, 41, 148, 138, 23, 16, 7, 132, 226, 137, 88, 198, 42, 155, 253, 216, 139,
                165, 103, 125, 137, 56, 96, 15, 52, 32, 138, 83, 187, 239, 5, 199, 3, 49, 89, 64,
                11, 121, 57, 97, 194, 95, 103, 17, 140, 249, 185, 27, 198, 7, 246, 144, 32, 212,
                216, 34, 111, 234, 48, 230, 71, 139, 143, 151, 195, 170, 53, 10, 103, 25, 125, 2,
                128, 77, 210, 84, 131, 244, 10, 132, 198, 1, 100, 5, 227, 107, 102, 21, 119, 237,
                105, 113, 21, 153, 3, 247, 167, 189, 133, 80, 169, 73, 227, 176, 187, 145, 85, 119,
                75, 98, 17, 67, 129, 165, 136, 182, 45, 134, 63, 29, 115, 92, 249, 5, 14, 122, 150,
                52, 37, 35, 187, 120, 212, 121, 44, 64, 46, 165, 91, 123, 93, 241, 56, 194, 66, 41,
                34, 148, 17, 44, 71, 98, 81, 195, 180, 254, 148, 185, 21, 64, 199, 229, 23, 11, 31,
                33, 71, 193, 74, 180, 123, 168, 140, 139, 91, 53, 78, 11, 77, 78, 43, 53, 140, 210,
                60, 144, 129, 17, 60, 8, 187, 7, 54, 105, 139, 83, 15, 208, 24, 169, 67, 97, 184,
                25, 219, 79, 59, 171, 122, 253, 184, 117, 172, 32, 57, 55, 21, 4, 159, 19, 126,
                178, 160, 118, 146, 200, 142, 169, 74, 175, 208, 183, 9, 165, 75, 17, 10, 33, 123,
                251, 65, 48, 189, 2, 73, 178, 203, 131, 44, 44, 57, 109, 38, 37, 207, 178, 16, 13,
                166, 71, 105, 1, 167, 150, 102, 28, 143, 251, 206, 64, 172, 115, 145, 99, 189, 237,
                120, 8, 58, 138, 164, 67, 233, 166, 127, 242, 0, 43, 164, 28, 78, 36, 155, 178, 84,
                158, 181, 229, 169, 18, 247, 153, 30, 252, 63, 133, 155, 204, 203, 243, 64, 152, 9,
                32, 146, 164, 60, 1, 242, 1, 38, 149, 176, 216, 186, 192, 199, 56, 167, 47, 10,
                179, 78, 16, 51, 61, 250, 179, 127, 137, 173, 189, 57, 77, 165, 140, 39, 214, 130,
                102, 47, 81, 94, 50, 86, 72, 151, 140, 64, 122, 164, 73, 13, 240, 26, 249, 121, 64,
                24, 156, 68, 78, 20, 59, 122, 36, 45, 53, 103, 94, 112, 36, 35, 55, 51, 101, 167,
                52, 61, 36, 213, 199, 207, 96, 136, 69, 195, 71, 83, 91, 130, 107, 120, 80, 219,
                160, 3, 64, 66, 8, 197, 171, 173, 115, 188, 183, 204, 89, 151, 68, 7, 188, 56, 70,
                16, 158, 204, 51, 47, 244, 166, 165, 128, 108, 204, 160, 57, 145, 102, 205, 183,
                188, 178, 130, 195, 11, 115, 187, 40, 159, 251, 106, 138, 105, 106, 220, 208, 136,
                44, 36, 42, 181, 235, 38, 160, 67, 135, 26, 118, 34, 246, 89, 191, 2, 246, 164,
                216, 245, 63, 23, 214, 51, 146, 81, 105, 33, 210, 96, 220, 185, 168, 91, 252, 158,
                245, 88, 29, 184, 68, 158, 210, 250, 59, 203, 12, 111, 218, 227, 91, 242, 27, 158,
                100, 117, 12, 11, 108, 99, 6, 214, 121, 252, 251, 141, 51, 65, 168, 11, 193, 16,
                48, 181, 29, 13, 148, 176, 23, 148, 6, 35, 81, 21, 237, 24, 10, 209, 3, 83, 92, 1,
                64, 238, 140, 161, 33, 230, 207, 116, 75, 84, 56, 167, 50, 123, 91, 18, 76, 116,
                33, 152, 116, 44, 17, 50, 170, 54, 33, 142, 109, 232, 60, 205, 150, 22, 251, 86,
                144, 157, 192, 156, 158, 83, 89, 39, 251, 125, 123, 245, 190, 151, 166, 206, 38,
                117, 156, 229, 139, 117, 239, 170, 77, 149, 114, 54, 183, 2, 102, 154, 75, 41, 210,
                114, 129, 181, 160, 73, 233, 18, 65, 3, 153, 1, 148, 57, 10, 229, 154, 32, 214,
                227, 82, 126, 148, 103, 247, 85, 74, 118, 164, 138, 155, 244, 117, 11, 160, 110,
                192, 183, 11, 120, 243, 148, 189, 104, 72, 192, 244, 83, 255, 245, 2, 120, 197,
                119, 13, 156, 111, 255, 1, 129, 236, 188, 74, 182, 100, 30, 199, 41, 74, 117, 198,
                150, 91, 146, 22, 138, 146, 174, 3, 240, 81, 18, 171, 42, 42, 76, 35, 213, 146,
                172, 119, 136, 88, 74, 153, 3, 113, 123, 131, 4, 74, 111, 74, 177, 206, 2, 85, 114,
                217, 56, 48, 63, 147, 32, 54, 74, 79, 90, 108, 42, 189, 88, 1, 57, 96, 187, 237,
                17, 11, 35, 54, 135, 91, 156, 3, 18, 246, 138, 96, 100, 161, 204, 152, 60, 77, 198,
                162, 230, 217, 201, 111, 117, 198, 239, 122, 35, 9, 244, 58, 126, 187, 150, 203,
                228, 115, 116, 16, 100, 107, 74, 86, 90, 218, 204, 184, 101, 36, 119, 165, 171,
                153, 203, 14, 183, 24, 18, 217, 24, 176, 74, 42, 204, 35, 228, 120, 125, 113, 203,
                252, 49, 20, 155, 107, 61, 25, 252, 166, 6, 69, 46, 168, 60, 172, 204, 137, 193,
                77, 135, 98, 191, 233, 172, 228, 181, 140, 89, 212, 119, 115, 35, 176, 228, 234,
                183, 90, 138, 0, 87, 145, 39, 249, 24, 173, 14, 213, 90, 161, 21, 121, 97, 80, 90,
                220, 182, 162, 179, 70, 189, 109, 156, 76, 79, 128, 117, 93, 196, 144, 59, 20, 96,
                25, 135, 63, 218, 22, 162, 241, 149, 193, 180, 164, 21, 87, 249, 64, 186, 102, 125,
                224, 106, 99, 54, 107, 96, 70, 148, 14, 37, 106, 1, 194, 106, 28, 183, 34, 55, 184,
                67, 102, 72, 18, 13, 251, 164, 59, 74, 243, 6, 0, 64, 61, 10, 19, 68, 85, 154, 195,
                141, 76, 106, 151, 55, 186, 80, 202, 68, 86, 211, 126, 217, 233, 119, 47, 84, 84,
                158, 172, 188, 90, 75, 83, 227, 34, 191, 125, 145, 55, 12, 103, 45, 205, 178, 5,
                196, 178, 107, 204, 151, 144, 69, 135, 198, 16, 74, 190, 14, 153, 96, 16, 124, 101,
                33, 8, 153, 219, 248, 158, 73, 86, 187, 38, 188, 176, 158, 86, 33, 76, 56, 196, 98,
                202, 129, 47, 106, 164, 168, 107, 141, 188, 27, 70, 161, 130, 132, 19, 100, 141,
                115, 57, 71, 176, 85, 19, 124, 212, 198, 229, 228, 160, 210, 60, 33, 57, 60, 152,
                55, 154, 110, 151, 234, 133, 33, 134, 82, 73, 228, 81, 214, 100, 46, 153, 161, 135,
                5, 242, 34, 125, 131, 194, 185, 2, 119, 159, 117, 137, 104, 69, 75, 180, 199, 131,
                15, 198, 190, 81, 21, 151, 133, 57, 179, 146, 198, 165, 125, 42, 22, 58, 151, 66,
                119, 12, 136, 18, 169, 25, 212, 164, 0, 163, 155, 189, 237, 41, 1, 166, 184, 145,
                230, 151, 44, 56, 133, 112, 252, 22, 20, 187, 246, 35, 89, 165, 21, 22, 152, 172,
                82, 82, 115, 223, 243, 36, 90, 100, 74, 40, 119, 190, 249, 66, 107, 80, 230, 5, 83,
                162, 89, 116, 161, 192, 226, 160, 144, 251, 119, 58, 167, 56, 120, 57, 219, 35,
                245, 112, 31, 204, 119, 119, 108, 184, 31, 250, 24, 125, 143, 197, 37, 170, 184,
                32, 142, 52, 124, 239, 247, 171, 161, 171, 73, 5, 204, 91, 21, 241, 105, 56, 113,
                181, 35, 184, 0, 31, 136, 173, 130, 19, 131, 150, 200, 53, 14, 249, 53, 87, 193,
                185, 109, 144, 151, 19, 3, 54, 210, 108, 39, 175, 216, 85, 170, 92, 3, 244, 56,
                204, 76, 70, 65, 122, 245, 56, 165, 193, 96, 70, 26, 114, 144, 214, 81, 145, 179,
                148, 246, 73, 90, 137, 132, 156, 199, 103, 50, 224, 27, 133, 115, 64, 195, 217,
                251, 17, 139, 231, 91, 179, 42, 196, 196, 75, 90, 143, 4, 114, 87, 132, 47, 111,
                152, 149, 180, 20, 159, 109, 163, 168, 21, 55, 40, 208, 229, 147, 205, 228, 13, 92,
                10, 11, 238, 138, 163, 218, 85, 93, 32, 83, 133, 198, 166, 142, 16, 180, 151, 142,
                243, 22, 65, 218, 196, 93, 122, 53, 13, 199, 129, 117, 151, 158, 122, 170, 80, 133,
                8, 65, 18, 11, 85, 119, 54, 53, 249, 24, 193, 245, 113, 110, 209, 235, 59, 227,
                241, 66, 15, 216, 206, 38, 32, 123, 71, 124, 38, 71, 102, 75, 242, 22, 159, 169,
                163, 61, 119, 24, 126, 78, 153, 151, 254, 210, 80, 235, 56, 25, 250, 160, 103, 39,
                18, 100, 230, 216, 21, 167, 124, 122, 249, 200, 84, 174, 106, 145, 53, 92, 160, 52,
                2, 64, 6, 224, 138, 2, 208, 28, 236, 134, 154, 25, 71, 87, 226, 243, 196, 16, 132,
                124, 136, 42, 145, 57, 37, 153, 197, 214, 88, 199, 154, 71, 207, 1, 50, 20, 187,
                129, 28, 16, 206, 119, 210, 175, 196, 18, 63, 150, 241, 102, 3, 43, 20, 55, 75,
                188, 188, 72, 154, 157, 39, 50, 77, 212, 137, 19, 73, 135, 159, 129, 0, 199, 216,
                206, 200, 200, 92, 181, 180, 93, 43, 1, 68, 255, 55, 75, 175, 241, 195, 58, 186,
                81, 225, 107, 6, 213, 48, 118, 131, 54, 122, 181, 197, 31, 156, 196, 94, 54, 160,
                87, 119, 116, 134, 64, 224, 109, 176, 82, 85, 139, 42, 33, 210, 170, 33, 97, 16,
                195, 49, 115, 71, 209, 145, 124, 58, 64, 4, 225, 215, 22, 0, 106, 1, 23, 114, 37,
                148, 50, 91, 5, 68, 183, 72, 8, 151, 24, 90, 39, 24, 33, 178, 119, 115, 34, 61, 24,
                112, 86, 213, 185, 196, 43, 204, 173, 161, 42, 6, 26, 62, 82, 122, 36, 249, 82,
                197, 218, 75, 205, 123, 186, 73, 104, 178, 168, 178, 152, 10, 64, 193, 7, 47, 18,
                38, 231, 167, 73, 208, 116, 143, 32, 235, 169, 208, 177, 122, 152, 245, 168, 45,
                233, 18, 138, 172, 105, 128, 145, 14, 72, 39, 153, 98, 217, 25, 23, 73, 149, 117,
                243, 103, 69, 230, 194, 122, 234, 162, 219, 9, 198, 140, 43, 26, 246, 91, 11, 251,
                186, 133, 254, 138, 83, 114, 105, 70, 80, 49, 62, 246, 198, 75, 69, 214, 196, 199,
                228, 75, 130, 181, 85, 189, 86, 41, 130, 21, 127, 91, 155, 44, 61, 130, 148, 148,
                83, 123, 91, 152, 116, 200, 120, 14, 7, 152, 173, 111, 188, 197, 103, 138, 201,
                116, 129, 136, 246, 49, 122, 111, 130, 104, 82, 9, 164, 103, 103, 61, 179, 226, 61,
                233, 171, 90, 214, 43, 31, 1, 84, 11, 125, 19, 50, 36, 176, 45, 107, 9, 51, 130,
                123, 86, 199, 105, 25, 133, 122, 81, 228, 67, 43, 142, 26, 27, 162, 245, 106, 7,
                245, 30, 87, 163, 196, 249, 118, 0, 212, 82, 169, 206, 3, 85, 63, 169, 153, 209,
                248, 22, 62, 71, 57, 158, 85, 159, 83, 193, 57, 44, 84, 99, 145, 114, 3, 222, 0,
                200, 59, 115, 191, 5, 233, 9, 2, 226, 40, 252, 184, 113, 188, 145, 139, 59, 136,
                103, 133, 0, 55, 3, 70, 10, 127, 220, 115, 188, 28, 46, 105, 228, 129, 36, 50, 196,
                115, 88, 143, 201, 51, 19, 142, 216, 120, 172, 119, 104, 228, 22, 33, 77, 80, 92,
                179, 115, 147, 81, 68, 186, 1, 200, 57, 228, 75, 10, 91, 74, 100, 84, 185, 106, 62,
                101, 149, 180, 180, 168, 35, 65, 30, 253, 246, 19, 68, 65, 173, 14, 86, 154, 230,
                219, 166, 60, 199, 139, 255, 184, 151, 77, 197, 98, 95, 91, 22, 37, 200, 157, 154,
                27, 193, 247, 5, 91, 25, 114, 5, 13, 69, 21, 4, 233, 7, 92, 12, 7, 151, 98, 96,
                235, 152, 47, 133, 51, 90, 98, 251, 83, 218, 197, 172, 30, 153, 154, 53, 246, 16,
                2, 40, 168, 246, 168, 188, 33, 51, 25, 211, 146, 173, 116, 134, 58, 204, 50, 86,
                250, 224, 40, 39, 204, 77, 67, 53, 159, 54, 179, 82, 34, 196, 10, 158, 219, 96, 62,
                98, 78, 246, 138, 64, 82, 60, 130, 213, 250, 59, 7, 252, 138, 48, 42, 14, 221, 215,
                33, 246, 178, 53, 97, 138, 121, 209, 25, 41, 182, 180, 5, 43, 96, 65, 65, 69, 4,
                28, 28, 12, 96, 0, 78, 134, 117, 49, 194, 240, 19, 251, 23, 29, 105, 215, 76, 176,
                67, 5, 218, 246, 18, 107, 80, 83, 118, 21, 79, 3, 38, 18, 96, 40, 15, 229, 55, 24,
                3, 217, 190, 111, 76, 113, 60, 107, 154, 21, 33, 189, 205, 145, 132, 139, 235, 107,
                254, 43, 54, 177, 81, 158, 132, 210, 5, 101, 176, 177, 238, 76, 25, 48, 57, 103,
                21, 10, 167, 32, 87, 165, 100, 184, 75, 120, 55, 119, 89, 19, 124, 191, 213, 3,
                201, 199, 199, 112, 149, 128, 227, 95, 144, 114, 167, 131, 197, 180, 230, 181, 217,
                219, 147, 146, 154, 165, 2, 143, 64, 103, 79, 187, 168, 176, 153, 46, 123, 167,
                197, 181, 67, 58, 56, 148, 100, 102, 244, 114, 51, 133, 171, 132, 199, 180, 13, 51,
                11, 122, 211, 182, 50, 36, 11, 236, 9, 93, 156, 194, 190, 26, 9, 156, 205, 158, 74,
                145, 185, 247, 91, 211, 32, 114, 46, 235, 50, 107, 117, 101, 134, 254, 21, 5, 125,
                122, 211, 124, 116, 114, 240, 111
            ]
        );
        assert_eq!(
            ek.as_bytes().as_slice(),
            [
                149, 114, 54, 183, 2, 102, 154, 75, 41, 210, 114, 129, 181, 160, 73, 233, 18, 65,
                3, 153, 1, 148, 57, 10, 229, 154, 32, 214, 227, 82, 126, 148, 103, 247, 85, 74,
                118, 164, 138, 155, 244, 117, 11, 160, 110, 192, 183, 11, 120, 243, 148, 189, 104,
                72, 192, 244, 83, 255, 245, 2, 120, 197, 119, 13, 156, 111, 255, 1, 129, 236, 188,
                74, 182, 100, 30, 199, 41, 74, 117, 198, 150, 91, 146, 22, 138, 146, 174, 3, 240,
                81, 18, 171, 42, 42, 76, 35, 213, 146, 172, 119, 136, 88, 74, 153, 3, 113, 123,
                131, 4, 74, 111, 74, 177, 206, 2, 85, 114, 217, 56, 48, 63, 147, 32, 54, 74, 79,
                90, 108, 42, 189, 88, 1, 57, 96, 187, 237, 17, 11, 35, 54, 135, 91, 156, 3, 18,
                246, 138, 96, 100, 161, 204, 152, 60, 77, 198, 162, 230, 217, 201, 111, 117, 198,
                239, 122, 35, 9, 244, 58, 126, 187, 150, 203, 228, 115, 116, 16, 100, 107, 74, 86,
                90, 218, 204, 184, 101, 36, 119, 165, 171, 153, 203, 14, 183, 24, 18, 217, 24, 176,
                74, 42, 204, 35, 228, 120, 125, 113, 203, 252, 49, 20, 155, 107, 61, 25, 252, 166,
                6, 69, 46, 168, 60, 172, 204, 137, 193, 77, 135, 98, 191, 233, 172, 228, 181, 140,
                89, 212, 119, 115, 35, 176, 228, 234, 183, 90, 138, 0, 87, 145, 39, 249, 24, 173,
                14, 213, 90, 161, 21, 121, 97, 80, 90, 220, 182, 162, 179, 70, 189, 109, 156, 76,
                79, 128, 117, 93, 196, 144, 59, 20, 96, 25, 135, 63, 218, 22, 162, 241, 149, 193,
                180, 164, 21, 87, 249, 64, 186, 102, 125, 224, 106, 99, 54, 107, 96, 70, 148, 14,
                37, 106, 1, 194, 106, 28, 183, 34, 55, 184, 67, 102, 72, 18, 13, 251, 164, 59, 74,
                243, 6, 0, 64, 61, 10, 19, 68, 85, 154, 195, 141, 76, 106, 151, 55, 186, 80, 202,
                68, 86, 211, 126, 217, 233, 119, 47, 84, 84, 158, 172, 188, 90, 75, 83, 227, 34,
                191, 125, 145, 55, 12, 103, 45, 205, 178, 5, 196, 178, 107, 204, 151, 144, 69, 135,
                198, 16, 74, 190, 14, 153, 96, 16, 124, 101, 33, 8, 153, 219, 248, 158, 73, 86,
                187, 38, 188, 176, 158, 86, 33, 76, 56, 196, 98, 202, 129, 47, 106, 164, 168, 107,
                141, 188, 27, 70, 161, 130, 132, 19, 100, 141, 115, 57, 71, 176, 85, 19, 124, 212,
                198, 229, 228, 160, 210, 60, 33, 57, 60, 152, 55, 154, 110, 151, 234, 133, 33, 134,
                82, 73, 228, 81, 214, 100, 46, 153, 161, 135, 5, 242, 34, 125, 131, 194, 185, 2,
                119, 159, 117, 137, 104, 69, 75, 180, 199, 131, 15, 198, 190, 81, 21, 151, 133, 57,
                179, 146, 198, 165, 125, 42, 22, 58, 151, 66, 119, 12, 136, 18, 169, 25, 212, 164,
                0, 163, 155, 189, 237, 41, 1, 166, 184, 145, 230, 151, 44, 56, 133, 112, 252, 22,
                20, 187, 246, 35, 89, 165, 21, 22, 152, 172, 82, 82, 115, 223, 243, 36, 90, 100,
                74, 40, 119, 190, 249, 66, 107, 80, 230, 5, 83, 162, 89, 116, 161, 192, 226, 160,
                144, 251, 119, 58, 167, 56, 120, 57, 219, 35, 245, 112, 31, 204, 119, 119, 108,
                184, 31, 250, 24, 125, 143, 197, 37, 170, 184, 32, 142, 52, 124, 239, 247, 171,
                161, 171, 73, 5, 204, 91, 21, 241, 105, 56, 113, 181, 35, 184, 0, 31, 136, 173,
                130, 19, 131, 150, 200, 53, 14, 249, 53, 87, 193, 185, 109, 144, 151, 19, 3, 54,
                210, 108, 39, 175, 216, 85, 170, 92, 3, 244, 56, 204, 76, 70, 65, 122, 245, 56,
                165, 193, 96, 70, 26, 114, 144, 214, 81, 145, 179, 148, 246, 73, 90, 137, 132, 156,
                199, 103, 50, 224, 27, 133, 115, 64, 195, 217, 251, 17, 139, 231, 91, 179, 42, 196,
                196, 75, 90, 143, 4, 114, 87, 132, 47, 111, 152, 149, 180, 20, 159, 109, 163, 168,
                21, 55, 40, 208, 229, 147, 205, 228, 13, 92, 10, 11, 238, 138, 163, 218, 85, 93,
                32, 83, 133, 198, 166, 142, 16, 180, 151, 142, 243, 22, 65, 218, 196, 93, 122, 53,
                13, 199, 129, 117, 151, 158, 122, 170, 80, 133, 8, 65, 18, 11, 85, 119, 54, 53,
                249, 24, 193, 245, 113, 110, 209, 235, 59, 227, 241, 66, 15, 216, 206, 38, 32, 123,
                71, 124, 38, 71, 102, 75, 242, 22, 159, 169, 163, 61, 119, 24, 126, 78, 153, 151,
                254, 210, 80, 235, 56, 25, 250, 160, 103, 39, 18, 100, 230, 216, 21, 167, 124, 122,
                249, 200, 84, 174, 106, 145, 53, 92, 160, 52, 2, 64, 6, 224, 138, 2, 208, 28, 236,
                134, 154, 25, 71, 87, 226, 243, 196, 16, 132, 124, 136, 42, 145, 57, 37, 153, 197,
                214, 88, 199, 154, 71, 207, 1, 50, 20, 187, 129, 28, 16, 206, 119, 210, 175, 196,
                18, 63, 150, 241, 102, 3, 43, 20, 55, 75, 188, 188, 72, 154, 157, 39, 50, 77, 212,
                137, 19, 73, 135, 159, 129, 0, 199, 216, 206, 200, 200, 92, 181, 180, 93, 43, 1,
                68, 255, 55, 75, 175, 241, 195, 58, 186, 81, 225, 107, 6, 213, 48, 118, 131, 54,
                122, 181, 197, 31, 156, 196, 94, 54, 160, 87, 119, 116, 134, 64, 224, 109, 176, 82,
                85, 139, 42, 33, 210, 170, 33, 97, 16, 195, 49, 115, 71, 209, 145, 124, 58, 64, 4,
                225, 215, 22, 0, 106, 1, 23, 114, 37, 148, 50, 91, 5, 68, 183, 72, 8, 151, 24, 90,
                39, 24, 33, 178, 119, 115, 34, 61, 24, 112, 86, 213, 185, 196, 43, 204, 173, 161,
                42, 6, 26, 62, 82, 122, 36, 249, 82, 197, 218, 75, 205, 123, 186, 73, 104, 178,
                168, 178, 152, 10, 64, 193, 7, 47, 18, 38, 231, 167, 73, 208, 116, 143, 32, 235,
                169, 208, 177, 122, 152, 245, 168, 45, 233, 18, 138, 172, 105, 128, 145, 14, 72,
                39, 153, 98, 217, 25, 23, 73, 149, 117, 243, 103, 69, 230, 194, 122, 234, 162, 219,
                9, 198, 140, 43, 26, 246, 91, 11, 251, 186, 133, 254, 138, 83, 114, 105, 70, 80,
                49, 62, 246, 198, 75, 69, 214, 196, 199, 228, 75, 130, 181, 85, 189, 86, 41, 130,
                21, 127, 91, 155, 44, 61, 130, 148, 148, 83, 123, 91, 152, 116, 200, 120, 14, 7,
                152, 173, 111, 188, 197, 103, 138, 201, 116, 129, 136, 246, 49, 122, 111, 130, 104,
                82, 9, 164, 103, 103, 61, 179, 226, 61, 233, 171, 90, 214, 43, 31, 1, 84, 11, 125,
                19, 50, 36, 176, 45, 107, 9, 51, 130, 123, 86, 199, 105, 25, 133, 122, 81, 228, 67,
                43, 142, 26, 27, 162, 245, 106, 7, 245, 30, 87, 163, 196, 249, 118, 0, 212, 82,
                169, 206, 3, 85, 63, 169, 153, 209, 248, 22, 62, 71, 57, 158, 85, 159, 83, 193, 57,
                44, 84, 99, 145, 114, 3, 222, 0, 200, 59, 115, 191, 5, 233, 9, 2, 226, 40, 252,
                184, 113, 188, 145, 139, 59, 136, 103, 133, 0, 55, 3, 70, 10, 127, 220, 115, 188,
                28, 46, 105, 228, 129, 36, 50, 196, 115, 88, 143, 201, 51, 19, 142, 216, 120, 172,
                119, 104, 228, 22, 33, 77, 80, 92, 179, 115, 147, 81, 68, 186, 1, 200, 57, 228, 75,
                10, 91, 74, 100, 84, 185, 106, 62, 101, 149, 180, 180, 168, 35, 65, 30, 253, 246,
                19, 68, 65, 173, 14, 86, 154, 230, 219, 166, 60, 199, 139, 255, 184, 151, 77, 197,
                98, 95, 91, 22, 37, 200, 157, 154, 27, 193, 247, 5, 91, 25, 114, 5, 13, 69, 21, 4,
                233, 7, 92, 12, 7, 151, 98, 96, 235, 152, 47, 133, 51, 90, 98, 251, 83, 218, 197,
                172, 30, 153, 154, 53, 246, 16, 2, 40, 168, 246, 168, 188, 33, 51, 25, 211, 146,
                173, 116, 134, 58, 204, 50, 86, 250, 224, 40, 39, 204, 77, 67, 53, 159, 54, 179,
                82, 34, 196, 10, 158, 219, 96, 62, 98, 78, 246, 138, 64, 82, 60, 130, 213, 250, 59,
                7, 252, 138, 48, 42, 14, 221, 215, 33, 246, 178, 53, 97, 138, 121, 209, 25, 41,
                182, 180, 5, 43, 96, 65, 65, 69, 4, 28, 28, 12, 96, 0, 78, 134, 117, 49, 194, 240,
                19, 251, 23, 29, 105, 215, 76, 176, 67, 5, 218, 246, 18, 107, 80, 83, 118, 21, 79,
                3, 38, 18, 96, 40, 15, 229, 55, 24, 3, 217, 190, 111, 76, 113, 60, 107, 154, 21,
                33, 189, 205, 145, 132, 139, 235, 107, 254, 43, 54, 177, 81, 158, 132, 210, 5, 101,
                176, 177, 238, 76, 25, 48, 57, 103, 21, 10, 167, 32, 87, 165, 100, 184, 75, 120,
                55, 119, 89, 19, 124, 191, 213, 3, 201, 199, 199, 112, 149, 128, 227, 95, 144, 114,
                167, 131, 197, 180, 230, 181, 217, 219, 147, 146, 154, 165, 2, 143, 64, 103, 79,
                187, 168, 176, 153, 46
            ]
        );
    }
}
